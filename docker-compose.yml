version: '3.8'

services:
  # --- TIER 3: PLATFORM (Cloud/VPS) ---
  db:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_USER: soccer
      POSTGRES_PASSWORD: soccerpassword
      POSTGRES_DB: soccer_platform
    volumes:
      - ./pgdata:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U soccer" ]
      interval: 5s
      timeout: 5s
      retries: 5

  platform:
    build:
      context: .
      dockerfile: soccer_platform/Dockerfile
    container_name: soccer_platform
    command: uvicorn soccer_platform.main:app --host 0.0.0.0 --port 8000
    volumes:
      - ./soccer_platform:/app/soccer_platform
      - ./soccer_platform/videos:/app/soccer_platform/videos
      - ./videos:/app/videos
    restart: always
    # Ports removed here, now proxied by Nginx
    expose:
      - "8000"
    environment:
      - DATABASE_URL=postgresql+asyncpg://soccer:soccerpassword@db:5432/soccer_platform
    depends_on:
      db:
        condition: service_healthy

  nginx:
    image: nginx:latest
    ports:
      - "80:80" # For ACME Challenge / HTTP Redirect
      - "4420:443" # MAIN HTTPS ACCESS
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
      - ./nginx/ssl:/etc/nginx/ssl
    command: "/bin/sh -c 'mkdir -p /etc/nginx/ssl/live && openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/nginx/ssl/live/selfsigned.key -out /etc/nginx/ssl/live/selfsigned.crt -subj \"/CN=localhost\" && nginx -g \"daemon off;\"'"
    depends_on:
      - platform

  certbot:
    image: certbot/certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

  # --- TIER 2: BENCH (GPU Processing) ---
  bench:
    build:
      context: .
      dockerfile: soccer_bench/Dockerfile
    container_name: soccer_bench
    restart: unless-stopped
    volumes:
      - ~/SoccerFootage:/root/SoccerFootage
    ports:
      - "4421:4421"
    environment:
      - PLATFORM_URL=http://platform:8000
      - TZ=UTC
    depends_on:
      - platform
    # GPU Support (Uncomment if needed)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
