<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Admin - TeamSnap Connection</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        .form-card {
            background: var(--bg-card);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--text-main);
        }

        input {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px 0;
            background: #fff;
            border: 1px solid var(--border);
            color: var(--text-main);
            display: block;
            border-radius: 6px;
        }

        label {
            color: var(--text-muted);
            font-size: 0.9em;
            display: block;
            text-align: left;
            margin-bottom: 5px;
            font-weight: 500;
        }

        /* Tabs */
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
            overflow-x: auto;
        }

        .tab-item {
            text-decoration: none;
            color: var(--text-muted);
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            white-space: nowrap;
        }

        .tab-item.active {
            background: var(--primary);
            color: white;
        }

        .tab-item:hover:not(.active) {
            background: rgba(0, 0, 0, 0.05);
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <button class="mobile-nav-toggle" onclick="toggleSidebar()">☰</button>
    <nav class="sidebar"></nav>

    <main class="main-content">
        <header class="top-bar">
            <h1 class="page-title">TeamSnap Integration</h1>
        </header>

        <div class="form-card" id="setupForm" style="display:none;">
            <h3>Configure TeamSnap</h3>
            <p style="color: var(--text-muted); font-size: 0.9em; margin-bottom: 20px;">
                Since TeamSnap treats apps privately, you must provide your own Developer Credentials.
                <br>1. Go to <a href="https://auth.teamsnap.com" target="_blank"
                    style="color: var(--primary);">auth.teamsnap.com</a>
                <br>2. Create an App with Redirect URI: <code
                    style="background:#e2e8f0; padding:2px; border-radius:4px; font-size:0.9em;"
                    id="redirectUriDisplay">.../teamsnap</code>
            </p>

            <label>Client ID</label>
            <input type="text" id="inpClientId" placeholder="Paste Client ID here...">

            <label>Client Secret</label>
            <input type="password" id="inpClientSecret" placeholder="Paste Client Secret here...">

            <button onclick="startConnection()" id="connectBtn"
                style="background: var(--primary); width: 100%; color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 10px;">
                Save & Connect TeamSnap
            </button>
        </div>

        <div class="form-card" id="processingCard" style="display:none; text-align:center;">
            <h3 id="statusTitle">Connecting...</h3>
            <p id="statusMsg" style="color:var(--text-muted);">Please wait while we complete the connection to TeamSnap.
            </p>

            <div id="loader" style="margin: 20px auto; font-size: 2em;">⏳</div>

            <button id="closeBtn" onclick="window.location.href='/admin/teams'"
                style="display:none; margin: 20px auto; background: var(--text-muted); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                Return to Admin
            </button>

            <!-- Partial Manual Form (Only for error fallback) -->
            <div id="manualFallback"
                style="display:none; text-align:left; margin-top:20px; border-top:1px solid var(--border); padding-top:20px;">
                <p style="color:#ef4444; font-size:0.9em;">If auto-exchange failed, verify creds:</p>
                <label>Client ID</label>
                <input type="text" id="retryClientId">
                <label>Client Secret</label>
                <input type="password" id="retryClientSecret">
                <button onclick="manualExchangeRetry()"
                    style="background:#22c55e; color:white; padding:8px; border:none; border-radius:4px; width:100%; margin-top:10px; cursor:pointer;">Retry
                    Connection</button>
            </div>
        </div>
    </main>

    <script src="/static/script.js"></script>
    <script>
        const token = localStorage.getItem('token');
        let currentUser = null;
        let authCode = null;

        (async function init() {
            if (typeof renderSidebar === 'function') renderSidebar('teamsnap');

            // Check for Auth Code in URL (Step 2 of OAuth)
            const t = localStorage.getItem('token');
            if (!t) {
                window.location.href = '/login';
                return;
            }

            try {
                const payload = JSON.parse(atob(t.split('.')[1]));
                // Document is now ready to use renderSidebar so we don't need to manually update navUserName
                // currentUser = payload; 
            } catch (e) {
                // Ignore token error for now
            }

            const urlParams = new URLSearchParams(window.location.search);
            authCode = urlParams.get('code');
            const error = urlParams.get('error');

            const statusTitle = document.getElementById('statusTitle');
            const statusMsg = document.getElementById('statusMsg');
            const loader = document.getElementById('loader');
            const closeBtn = document.getElementById('closeBtn');
            const setupForm = document.getElementById('setupForm');
            const processing = document.getElementById('processingCard');

            // Set Redirect URI display
            document.getElementById('redirectUriDisplay').innerText = window.location.origin + "/teamsnap";

            if (error) {
                processing.style.display = 'block';
                statusTitle.innerText = "Connection Failed";
                statusMsg.innerText = "TeamSnap returned an error: " + error;
                loader.innerText = "❌";
                closeBtn.style.display = "block";
                return;
            }

            if (!authCode) {
                setupForm.style.display = 'block';
                const storedId = localStorage.getItem('tsClientId');
                const storedSecret = sessionStorage.getItem('tsClientSecretTemp');
                if (storedId) document.getElementById('inpClientId').value = storedId;
                if (storedSecret) document.getElementById('inpClientSecret').value = storedSecret;

                // Add Blur Listeners for Auto-Save
                document.getElementById('inpClientId').addEventListener('blur', savePartialCreds);
                document.getElementById('inpClientSecret').addEventListener('blur', savePartialCreds);
                return;
            }

            // Callback Mode
            processing.style.display = 'block';
            setupForm.style.display = 'none';

            const storedId = localStorage.getItem('tsClientId');
            const storedSecret = sessionStorage.getItem('tsClientSecretTemp');

            if (storedId && storedSecret) {
                await executeExchange(storedId, storedSecret);
            } else {
                statusTitle.innerText = "Credentials Missing";
                statusMsg.innerText = "Session lost during redirect. Please re-enter credentials.";
                loader.innerText = "⚠️";
                document.getElementById('manualFallback').style.display = 'block';
                if (storedId) document.getElementById('retryClientId').value = storedId;
            }
        })();

        async function savePartialCreds() {
            const client_id = document.getElementById('inpClientId').value.trim();
            const client_secret = document.getElementById('inpClientSecret').value.trim();

            // Save to local storage for immediate persistence
            if (client_id) localStorage.setItem('tsClientId', client_id);
            if (client_secret) sessionStorage.setItem('tsClientSecretTemp', client_secret);

            if (!client_id && !client_secret) return; // Nothing to save

            try {
                // Silent save to backend
                await fetch('/api/me/teamsnap_creds', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ client_id, client_secret })
                });
                console.log("Credentials auto-saved.");
            } catch (e) {
                console.warn("Auto-save failed", e);
            }
        }

        async function startConnection() {
            const btn = document.getElementById('connectBtn');
            const client_id = document.getElementById('inpClientId').value.trim();
            const client_secret = document.getElementById('inpClientSecret').value.trim();

            if (!client_id || !client_secret) {
                alert("Please enter both Client ID and Secret.");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Redirecting...";

            try {
                // 1. Save to Backend (Explicit Save before redirect)
                await fetch('/api/me/teamsnap_creds', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ client_id, client_secret })
                });

                localStorage.setItem('tsClientId', client_id);
                sessionStorage.setItem('tsClientSecretTemp', client_secret);

                const redirect_uri = window.location.origin + "/teamsnap";
                // Add state param for security if needed, but keeping simple for now
                const authUrl = `https://auth.teamsnap.com/oauth/authorize?client_id=${client_id}&redirect_uri=${encodeURIComponent(redirect_uri)}&response_type=code&scope=read+write`;

                window.location.href = authUrl;

            } catch (e) {
                alert("Error: " + e.message);
                btn.disabled = false;
                btn.innerText = "Save & Connect TeamSnap";
            }
        }

        async function manualExchangeRetry() {
            const cid = document.getElementById('retryClientId').value.trim();
            const csec = document.getElementById('retryClientSecret').value.trim();
            if (!cid || !csec) { alert("Missing credentials"); return; }
            localStorage.setItem('tsClientId', cid);
            sessionStorage.setItem('tsClientSecretTemp', csec);
            await executeExchange(cid, csec);
        }

        async function executeExchange(clientId, clientSecret) {
            const statusTitle = document.getElementById('statusTitle');
            const statusMsg = document.getElementById('statusMsg');
            const loader = document.getElementById('loader');

            try {
                const redirectUri = window.location.origin + "/teamsnap";
                const payload = {
                    client_id: clientId,
                    client_secret: clientSecret,
                    code: authCode,
                    redirect_uri: redirectUri
                };

                const res = await fetch('/api/settings/teamsnap_exchange', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    statusTitle.innerText = "Connected Successfully!";
                    statusMsg.innerText = "TeamSnap integration is now active.";
                    loader.innerText = "✅";
                    sessionStorage.removeItem('tsClientSecretTemp');

                    // Redirect to Teams tab after success? Or stay?
                    setTimeout(() => {
                        // Go to Admin Teams list to see result?
                        window.location.href = '/admin/teams';
                    }, 2000);

                } else {
                    const err = await res.json();
                    throw new Error(err.detail || "Exchange failed.");
                }
            } catch (e) {
                statusTitle.innerText = "Connection Failed";
                statusMsg.innerText = e.message;
                loader.innerText = "❌";
                document.getElementById('closeBtn').style.display = "block";
                document.getElementById('manualFallback').style.display = 'block';
                document.getElementById('retryClientId').value = clientId;
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login';
        }
    </script>
</body>

</html>