<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>TeamSnap Connector</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .admin-container {
            max-width: 600px;
            margin: 40px auto;
        }

        .form-card {
            background: var(--glass);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="app-container admin-container">
        <header class="glass-header">
            <div class="logo">TeamSnap Connector</div>
            <div style="flex-grow: 1; margin-left: 20px;">
                <a href="/settings" style="color: #cbd5e1; text-decoration: none; margin-right: 15px;">Back to
                    Settings</a>
            </div>
        </header>

        <div class="form-card" id="connectionForm" style="display:none; text-align: left;">
            <h3>Finalize Connection</h3>
            <p style="color: #ccc; margin-bottom: 20px;">
                We received an authorization code from TeamSnap! <br>
                To finish securing the connection, please paste the <strong>Client ID</strong> and <strong>Client
                    Secret</strong> from your TeamSnap Developer Portal.
            </p>

            <label>Client ID</label>
            <input type="text" id="inpClientId" placeholder="Paste Client ID here...">

            <label>Client Secret</label>
            <input type="password" id="inpClientSecret" placeholder="Paste Client Secret here...">

            <button onclick="manualExchange()"
                style="background: #22c55e; width: 100%; color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 10px;">
                Complete Connection
            </button>
        </div>

        <div class="form-card" id="processingCard" style="margin-top: 50px;">
            <h3 id="statusTitle">Connecting...</h3>
            <p id="statusMsg">Please wait while we complete the connection to TeamSnap.</p>

            <div id="loader" style="margin: 20px auto; font-size: 2em;">⏳</div>

            <button id="closeBtn" onclick="window.location.href='/settings'"
                style="display:none; margin: 20px auto; background: #334155; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                Return to Settings
            </button>
        </div>
    </div>

    <script>
        // Global state for code
        let authCode = null;

        (async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            authCode = urlParams.get('code');
            const error = urlParams.get('error');

            const statusTitle = document.getElementById('statusTitle');
            const statusMsg = document.getElementById('statusMsg');
            const loader = document.getElementById('loader');
            const closeBtn = document.getElementById('closeBtn');
            const form = document.getElementById('connectionForm');
            const processing = document.getElementById('processingCard');

            if (error) {
                statusTitle.innerText = "Connection Failed";
                statusMsg.innerText = "TeamSnap returned an error: " + error;
                loader.innerText = "❌";
                closeBtn.style.display = "block";
                return;
            }

            if (!authCode) {
                // If here without code, maybe user just navigated here manually.
                processing.style.display = 'none';
                form.style.display = 'none'; // Or show directions?
                document.body.innerHTML += "<div style='text-align:center; margin-top:50px;'>No code found. Please initiate connection from Settings or TeamSnap.</div>";
                return;
            }

            // 1. Try Auto-Connect (if started from Settings)
            const storedId = localStorage.getItem('tsClientId');
            const storedSecret = sessionStorage.getItem('tsClientSecretTemp');

            if (storedId && storedSecret) {
                // We have everything, proceed automatically
                await executeExchange(storedId, storedSecret);
            } else {
                // 2. Cold Start (User came from TeamSnap Dashboard)
                // Hide processing, Show Form
                processing.style.display = 'none';
                form.style.display = 'block';

                // Pre-fill ID if we have it at least
                if (storedId) document.getElementById('inpClientId').value = storedId;
            }
        })();

        async function manualExchange() {
            const cid = document.getElementById('inpClientId').value.trim();
            const csec = document.getElementById('inpClientSecret').value.trim();

            if (!cid || !csec) {
                alert("Both Client ID and Client Secret are required.");
                return;
            }

            // Show processing again
            document.getElementById('connectionForm').style.display = 'none';
            document.getElementById('processingCard').style.display = 'block';

            // Store ID for future
            localStorage.setItem('tsClientId', cid);

            await executeExchange(cid, csec);
        }

        async function executeExchange(clientId, clientSecret) {
            const statusTitle = document.getElementById('statusTitle');
            const statusMsg = document.getElementById('statusMsg');
            const loader = document.getElementById('loader');
            const closeBtn = document.getElementById('closeBtn');

            try {
                // Redirect URI must match the current page exactly
                // Remove query params for the Redirect URI base
                const redirectUri = window.location.origin + window.location.pathname;

                const payload = {
                    client_id: clientId,
                    client_secret: clientSecret,
                    code: authCode,
                    redirect_uri: redirectUri
                };

                const res = await fetch('/api/settings/teamsnap_exchange', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    statusTitle.innerText = "Connected Successfully!";
                    statusMsg.innerText = "TeamSnap integration is now active. You may now sync your teams.";
                    loader.innerText = "✅";

                    // Cleanup
                    sessionStorage.removeItem('tsClientSecretTemp');

                    setTimeout(() => {
                        window.location.href = '/settings';
                    }, 2000);

                } else {
                    const err = await res.json();
                    throw new Error(err.detail || "Exchange failed on server.");
                }
            } catch (e) {
                console.error(e);
                statusTitle.innerText = "Connection Failed";
                statusMsg.innerText = e.message;
                loader.innerText = "❌";
                closeBtn.style.display = "block";

                // If manual, maybe allow retry?
                // For now, fail safe.
            }
        }
    </script>
</body>

</html>