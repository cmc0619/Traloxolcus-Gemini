<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>TeamSnap Connector</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .admin-container {
            max-width: 600px;
            margin: 40px auto;
        }

        .form-card {
            background: var(--glass);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
        }

        input {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px 0;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #334155;
            color: white;
            display: block;
        }

        label {
            color: #94a3b8;
            font-size: 0.9em;
            display: block;
            text-align: left;
        }
    </style>
</head>

<body>
    <div class="app-container admin-container">
        <header class="glass-header">
            <div class="logo">TeamSnap Connector</div>
            <div style="flex-grow: 1; margin-left: 20px;">
                <a href="/settings" style="color: #cbd5e1; text-decoration: none; margin-right: 15px;">Back to
                    Settings</a>
            </div>
        </header>

        <!-- SETUP FORM (Shown if no code) -->
        <div class="form-card" id="setupForm" style="display:none; text-align: left;">
            <h3>Configure TeamSnap</h3>
            <p style="color: #ccc; font-size: 0.9em; margin-bottom: 20px;">
                Since TeamSnap treats apps privately, you must provide your own Developer Credentials.
                <br>1. Go to <a href="https://developer.teamsnap.com" target="_blank"
                    style="color: #3b82f6;">developer.teamsnap.com</a>
                <br>2. Create an App with Redirect URI: <code style="background:#334; padding:2px;"
                    id="redirectUriDisplay">.../teamsnap</code>
            </p>

            <label>Client ID</label>
            <input type="text" id="inpClientId" placeholder="Paste Client ID here...">

            <label>Client Secret</label>
            <input type="password" id="inpClientSecret" placeholder="Paste Client Secret here...">

            <button onclick="startConnection()"
                style="background: #ea580c; width: 100%; color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 10px;">
                Save & Connect TeamSnap
            </button>
        </div>

        <!-- PROCESSING CARD (Shown if code exists) -->
        <div class="form-card" id="processingCard" style="display:none; margin-top: 50px;">
            <h3 id="statusTitle">Connecting...</h3>
            <p id="statusMsg">Please wait while we complete the connection to TeamSnap.</p>

            <div id="loader" style="margin: 20px auto; font-size: 2em;">⏳</div>

            <button id="closeBtn" onclick="window.location.href='/settings'"
                style="display:none; margin: 20px auto; background: #334155; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                Return to Settings
            </button>

            <!-- Partial Manual Form (Only for error fallback) -->
            <div id="manualFallback"
                style="display:none; text-align:left; margin-top:20px; border-top:1px solid #444; padding-top:20px;">
                <p style="color:#ef4444; font-size:0.9em;">If auto-exchange failed, verify creds:</p>
                <label>Client ID</label>
                <input type="text" id="retryClientId">
                <label>Client Secret</label>
                <input type="password" id="retryClientSecret">
                <button onclick="manualExchangeRetry()"
                    style="background:#22c55e; color:white; padding:8px; border:none; border-radius:4px; width:100%; margin-top:10px;">Retry
                    Connection</button>
            </div>
        </div>
    </div>

    <script>
        // Global state for code
        let authCode = null;

        (async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            authCode = urlParams.get('code');
            const error = urlParams.get('error');

            const statusTitle = document.getElementById('statusTitle');
            const statusMsg = document.getElementById('statusMsg');
            const loader = document.getElementById('loader');
            const closeBtn = document.getElementById('closeBtn');
            const setupForm = document.getElementById('setupForm');
            const processing = document.getElementById('processingCard');

            // Set Redirect URI display
            document.getElementById('redirectUriDisplay').innerText = window.location.origin + "/teamsnap";

            if (error) {
                processing.style.display = 'block';
                statusTitle.innerText = "Connection Failed";
                statusMsg.innerText = "TeamSnap returned an error: " + error;
                loader.innerText = "❌";
                closeBtn.style.display = "block";
                return;
            }

            if (!authCode) {
                // Setup Mode
                setupForm.style.display = 'block';
                // Pre-fill ID/Secret if stored
                const storedId = localStorage.getItem('tsClientId');
                const storedSecret = sessionStorage.getItem('tsClientSecretTemp'); // Or maybe don't pre-fill secret for security, but user exp.
                if (storedId) document.getElementById('inpClientId').value = storedId;
                if (storedSecret) document.getElementById('inpClientSecret').value = storedSecret;
                return;
            }

            // Callback Mode
            processing.style.display = 'block';

            // 1. Try Auto-Connect
            const storedId = localStorage.getItem('tsClientId');
            const storedSecret = sessionStorage.getItem('tsClientSecretTemp');

            if (storedId && storedSecret) {
                await executeExchange(storedId, storedSecret);
            } else {
                // We have code but lost creds? Show error and fallback
                statusTitle.innerText = "Credentials Missing";
                statusMsg.innerText = "Session lost during redirect. Please re-enter credentials.";
                loader.innerText = "⚠️";
                document.getElementById('manualFallback').style.display = 'block';
                // Pre-fill ID if available
                if (storedId) document.getElementById('retryClientId').value = storedId;
            }
        })();

        async function startConnection() {
            const client_id = document.getElementById('inpClientId').value.trim();
            const client_secret = document.getElementById('inpClientSecret').value.trim();

            if (!client_id || !client_secret) {
                alert("Please enter both Client ID and Secret.");
                return;
            }

            // 1. Save to Backend
            try {
                const token = localStorage.getItem('token');
                const res = await fetch('/api/me/teamsnap_creds', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ client_id, client_secret })
                });

                if (!res.ok) throw new Error("Failed to save credentials");

                // 2. Redirect
                localStorage.setItem('tsClientId', client_id);
                sessionStorage.setItem('tsClientSecretTemp', client_secret);

                const redirect_uri = window.location.origin + "/teamsnap";
                const authUrl = `https://auth.teamsnap.com/oauth/authorize?client_id=${client_id}&redirect_uri=${encodeURIComponent(redirect_uri)}&response_type=code&scope=read+write`;

                window.location.href = authUrl;

            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        async function manualExchangeRetry() {
            const cid = document.getElementById('retryClientId').value.trim();
            const csec = document.getElementById('retryClientSecret').value.trim();
            if (!cid || !csec) { alert("Missing credentials"); return; }

            // Update storage
            localStorage.setItem('tsClientId', cid);
            sessionStorage.setItem('tsClientSecretTemp', csec); // Re-save

            await executeExchange(cid, csec);
        }

        async function executeExchange(clientId, clientSecret) {
            const statusTitle = document.getElementById('statusTitle');
            const statusMsg = document.getElementById('statusMsg');
            const loader = document.getElementById('loader');
            const closeBtn = document.getElementById('closeBtn');

            try {
                const redirectUri = window.location.origin + "/teamsnap"; // Clean URL

                const payload = {
                    client_id: clientId,
                    client_secret: clientSecret,
                    code: authCode,
                    redirect_uri: redirectUri
                };

                const res = await fetch('/api/settings/teamsnap_exchange', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    statusTitle.innerText = "Connected Successfully!";
                    statusMsg.innerText = "TeamSnap integration is now active.";
                    loader.innerText = "✅";

                    // Cleanup
                    sessionStorage.removeItem('tsClientSecretTemp');

                    setTimeout(() => {
                        window.location.href = '/settings';
                    }, 2000);

                } else {
                    const err = await res.json();
                    throw new Error(err.detail || "Exchange failed on server.");
                }
            } catch (e) {
                console.error(e);
                statusTitle.innerText = "Connection Failed";
                statusMsg.innerText = e.message;
                loader.innerText = "❌";
                closeBtn.style.display = "block";
                document.getElementById('manualFallback').style.display = 'block';
                document.getElementById('retryClientId').value = clientId;
            }
        }
    </script>
</body>

</html>